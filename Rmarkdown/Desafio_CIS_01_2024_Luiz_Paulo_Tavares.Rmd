---
title: 'Processo Seletivo 2024: IEEE Computational Intelligence Society, UnB'
author: "Luiz Paulo Tavares Gonçalves"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r message=FALSE, warning=FALSE}

base::rm(list = ls())
grDevices::graphics.off()
setwd("~/Github/Projetos/IEEE/db")

# Dependências 

pacman::p_load(DataExplorer, 
               tidyverse,
               stargazer,
               glmnet,
               Amelia,
               GGally,
               broom,
               knitr,
               nnet, 
               vip,
               car)
```


```{r}
# CONSTANTES & VAR GLOBAIS 

THRESHOLD = 2

```

# Import dataset, cleaning & Validation

Após a importação do dataset os nomes das colunas são padronizados, assim, retirando caracteres especiais e espaços e, em segundo, é validado a não existência de duplicação de pacientes (no presente caso, duplicação de ID's). 


```{r message=FALSE, warning=FALSE}


data_raw = readr::read_csv("Drugs.csv") %>% 
           janitor::clean_names() %>% 
           dplyr::distinct(id, .keep_all = TRUE) 


```

# **QUESTÃO 01**: No dataset existem alguns valores faltantes. Antes de começar a manipular os dados, trate essas informações e descreva sucintamente as alterações feitas

```{r message=FALSE, warning=FALSE}
 
# Verificando a presença de NA's 

Amelia::missmap(data_raw, 
                col = c('red','darkorange'),
                main ='Mapa de Valores Faltantes',
                legend = T) 

# DataExplorer::plot_intro(data = data_raw)

# Calculando a porcentagem de dados faltantes em cada variável

percent_missing_df <- function(df) {

  missing_test <- base::sapply(df, function(x) {
    
    sum(is.na(x)) / length(x) * 100
    
  })
  
 missing_pct = missing_test %>% 
               base::as.data.frame() %>% 
               dplyr::arrange(desc(.)) %>% 
               dplyr::rename("%" = ".") 
   
  
   table_missing = knitr::kable(missing_pct,
               caption = "Porcentagem de NA's nas variáveis do Dataset",  
               col.names = c("Variáveis do Dataset", 
                             "Porcentagem"),
               format = "markdown")
  
  
  return(table_missing)
}

```

Como pode ser verificado no gráfico anterior, há aproximadamente 3% de missings no dataset.Com destaque para a variável **income**. Assim, a seguir é calculado e apresentado a porcentagem de NA's em cada variável: 


```{r}
percent_missing_df(data_raw)
```

A variável renda (income) tem os incríveis 98,78% de observações como NA's. O restante de variáveis não ultrapassa 0.40% quando o assunto é a presença de NA's. **Por simplificidade e tempo de análise, assume-se a partir de agora a remoção da variável renda e da linha que tenha NA, isto é, do ID que tenha em alguma variável dados faltantes. Assim,  restando 1853 linhas, ou seja, 1853 id's diferentes na base de dados para análise.**   

```{r}
data_clean = data_raw %>% 
             # Retirando a variável income por ter 98.78% de NA's 
            dplyr::select(-income_usd) %>% 
            stats::na.omit() %>% 
            dplyr::mutate(age_factor = case_when(age == "18-24" ~ 1, 
                                                 age == "25-34" ~ 2, 
                                                 age == "35-44" ~ 3, 
                                                 age == "45-54" ~ 4, 
                                                 age == "55-64" ~ 5, 
                                                 age == "65+" ~ 6))
```


# **QUESTÃO 02**: Qual é a distribuição da idade dos indivíduos na amostra? Existem diferenças significativas nas faixas etárias predominantes de consumo entre os grupos de usuários de diferentes substâncias?

```{r message=FALSE, warning=FALSE}
AGE <- c("18-24", "25-34", "35-44", "45-54", "55-64", "65+")

ggplot2::ggplot(data_clean) +
         aes(x = as.factor(age_factor), 
             fill = age) + 
         geom_bar() +
         scale_x_discrete(labels = AGE) + 
         scale_fill_brewer(palette = "Oranges", 
                           direction = -1) +  
         labs(title = "Distribuição da Idade dos Indivíduos da Amostra", 
              #subtitle = "Variável Discreta",
              y = "Contagem",
              x = "",
              fill = "") + 
  theme_minimal() +
  theme(legend.position = "bottom")


freqs_age <- data_clean %>% 
             dplyr::group_by(age) %>% 
             dplyr::summarise(n = n()) %>% 
                    ungroup() %>% 
                    mutate(total = base::sum(n), 
                    pct = base::round((n/total)*100, THRESHOLD)) %>% select(-total)
```

**Na tabela a seguir pode-se visualizar a frequência absoluta e relativa para a idade dos indivíduos da amostra:**

```{r message=FALSE, warning=FALSE}
knitr::kable(freqs_age,
             caption = "Estatísticas Descritivas da variável Idade",  
             col.names = c("Idade", 
                           "Frequência Absoluta", 
                           "Frequência Relativa"),
             format = "markdown")
```

Como pode ser observado, a população jovem, entre 18 a 34, ocupa a maior parcela da amostra; somando-se um total de 59,79% da amostra. Agora vamos segmentar o mesmo cálculo por grupos de usuários de diferentes substâncias. 


```{r message=FALSE, warning=FALSE}
# Segmento por grupos de usuários de diferentes substâncias

seg_age <- data_clean %>% 
           dplyr::select(id, 
                         age, 
                         alcohol:vsa) %>% 
           tidyr::pivot_longer(cols = alcohol:vsa, 
                               values_to = "classification") %>% 
           dplyr::group_by(age, classification, name) %>% 
                  summarise(freq_abs = n()) %>% 
                  ungroup()

ggplot2::ggplot(seg_age) +
        aes(x = age, y = freq_abs, fill = classification) +
        geom_col(position = "fill") +
        scale_fill_brewer(palette = "Oranges", direction = -1) +
        labs(title = "Idade Segmentada por grupos de usuários e substância",
             y = "%",
             x = "",
             fill = "")+
        coord_flip() +
        theme_minimal()+
        theme(legend.position = "bottom")+
        facet_wrap(vars(name))


```

Há 19 substâncias diferentes com 7 classificações possíveis: 

CL0: Nunca Usou

CL1: Usou Mais de Uma Década Atrás

CL2: Usou nos Últimos Dez Anos

CL3: Usou no Último Ano (59 vezes)

CL4: Usou nos Últimos Meses

CL5: Usou na Última Semana

CL6: Usou Hoje

**Aparentemente há uma relação, menor a idade, maior a proporção de uso de substâncias, isto é, menor a chancer para a classificação "nunca usou".** 

# **QUESTÃO 03**: Há uma relação entre o nível educacional e o consumo de substâncias?

# **QUESTÃO 04**: Como o gênero influencia no consumo de drogas alucinógenas (LSD, Ecstasy, Ketamine, Cannabis e Mushrooms)? Explique.

Para esse problema podemos modelar um modelo multinominal, isto é, um modelo logit (binário) expandido para inferir sobre a existência de influência do gênero no consumo de drogas alucionógenas. Assim, pode-se tomar as ordens de consumo(CLO...CL6) como variável depedente e, por sua vez, a idade como variável explicativa. Porém, observe que a variável dependente no presente caso não é binária, então, precisamos estender o modelo logit para estimar os parâmetros tornando-se um modelo multinominal. O qual   assume a forma de logito para a k-ésima categoria em relação a uma categoria de referência (**no presente caso, CL0, isto é, a categoria "nunca usou"**), expresso como:

$$
\log \left( \frac{P(Y = k)}{P(Y = 1)} \right) = \beta_{k0} + \beta_{k1} x_1 + \ldots + \beta_{kp} x_p
$$

Assim, as probabilidades para todas as k categorias são obtidas através da função softmax, que normaliza as probabilidades:

$$
P(Y = k) = \frac{\exp(\beta_{k0} + \beta_{k1} x_1 + \ldots + \beta_{kp} x_p)}{\sum_{l=1}^{K} \exp(\beta_{l0} + \beta_{l1} x_1 + \ldots + \beta_{lp} x_p)}
$$

```{r message=FALSE, warning=FALSE}
evid_gender = data_clean %>% 
              dplyr::select(id, gender, 
                            lsd, 
                            ecstasy,
                            ketamine, 
                            cannabis, 
                            mushrooms) %>% 
              tidyr::pivot_longer(lsd:mushrooms, 
                                  values_to = "classification") %>% 
              dplyr::mutate(uso = ifelse(classification == "CL0", 1,0),
                            classification = factor(classification), 
                            gender = factor(gender))
```


```{r message=FALSE, warning=FALSE, include=FALSE}
model_multinominal <- nnet::multinom(classification ~ gender, data = evid_gender)
```


```{r message=FALSE, warning=FALSE}

# summary(model_multinominal)

odds_ratios <- base::exp(coef(model_multinominal))
```

**Estimando o modelo temos:** 

```{r message=FALSE, warning=FALSE}
knitr::kable(odds_ratios, 
       caption = "Coeficientes do Modelo Multinominal")
```

## Interpretação de cada coeficiente: 


**CL1 - Usou Mais de Uma Década Atrás:**

Intercepto: A chance de uma mulher estar na categoria CL1 em vez de CL0 é aproximadamente 0.141.

Gênero Masculino: A chance de um homem estar na categoria CL1 em vez de CL0 é 1.448 vezes a chance de uma mulher.

**CL2 - Usou nos Últimos Dez Anos:**

Intercepto: A chance de uma mulher estar na categoria CL2 em vez de CL0 é aproximadamente 0.163.

Gênero Masculino: A chance de um homem estar na categoria CL2 em vez de CL0 é 1.846 vezes a chance de uma mulher.

**CL3 - Usou no Último Ano:**

Intercepto: A chance de uma mulher estar na categoria CL3 em vez de CL0 é aproximadamente 0.123.

Gênero Masculino: A chance de um homem estar na categoria CL3 em vez de CL0 é 3.031 vezes a chance de uma mulher.

**CL4 - Usou nos Últimos Meses:**

Intercepto: A chance de uma mulher estar na categoria CL4 em vez de CL0 é aproximadamente 0.055.

Gênero Masculino: A chance de um homem estar na categoria CL4 em vez de CL0 é 3.527 vezes a chance de uma mulher.

**CL5 - Usou na Última Semana:**

Intercepto: A chance de uma mulher estar na categoria CL5 em vez de CL0 é aproximadamente 0.037.

Gênero Masculino: A chance de um homem estar na categoria CL5 em vez de CL0 é 3.612 vezes a chance de uma mulher.

**CL6 - Usou Hoje:**

Intercepto: A chance de uma mulher estar na categoria CL6 em vez de CL0 é aproximadamente 0.056.

Gênero Masculino: A chance de um homem estar na categoria CL6 em vez de CL0 é 3.081 vezes a chance de uma mulher.


## Conclusão geral: 

**Nota-se que os homens são mais vuneráveis na possibilidade de consumir alguma substância. A chance de um homem consumir "hoje" alguma droga é 3.081 vezes a chance de uma mulher (enquanto de uma mulher consumir "hoje" é de apenas 0.056)**.  



```{r message=FALSE, warning=FALSE}
odds_ratios <- odds_ratios %>% 
               base::as.data.frame() %>% 
               janitor::clean_names() %>% 
               rename(Homem = gender_m, 
                      Mulher = intercept) %>% 
               mutate(classe = c("CL1", "CL2","CL3","CL4","CL5","CL6")) %>% 
               tidyr::pivot_longer(cols = Homem:Mulher)
```


### Os coeficientes podem ser resumidos no seguinte plote para uma melhor visualização: 


```{r message=FALSE, warning=FALSE}
ggplot(odds_ratios, 
       aes(classe, value, colour = name))+
  geom_point()+
  labs(title = "Coeficientes: Modelo Multinominal/Politômico",
       y = "Coeficientes", x = "Uso de substâncias", colour = "")+
  theme_minimal()+
  theme(legend.position = "bottom")


```

# **QUESTÃO 05**: Qual é a proporção de participantes que se auto-classificam como impulsivos (score superior a zero)? Existe uma correlação entre a impulsividade e o consumo de substâncias?

```{r message=FALSE, warning=FALSE}

impulse <- data_clean %>% 
            dplyr::select(id, 
                          impulsive, 
                          alcohol:vsa) %>% 
                    mutate(impulsive = as.numeric(impulsive)) %>% 
            stats::na.omit()

# score superior a zero == Impulsivo 

auto_classificam = table(impulse$impulsive > 0)


ggplot(impulse) +
  aes(x = impulsive) +
  geom_histogram(bins = 30L, fill = "darkorange") +
  labs(title = "Distribuição da Impulsividade", x = "", y = "") +
  theme_minimal() +
  geom_vline(xintercept = 0, 
             color = "black",
             linetype = "dashed") +
  annotate("text", 
           x = 1.5, y = 350,
           label = paste0(round((auto_classificam[2] / (auto_classificam[1] + auto_classificam[2]))*100, 2), "% se classificam como impulsivos"), 
           color = "black", angle = 0, vjust = 0)


```

Sabendo que quase 50% dos entrevistados consideram-se impulsivos, vamos agora calcular a correlação de Spearman (considerando não normalidade entre a correlação da impulsividade com as substâncias - variável ordinal de 1 a 7). A correlação de Spearman pode ser calculada como segue: 

$$
\rho = 1 - \frac{6 \sum d_i^2}{n(n^2 - 1)}
$$

```{r message=FALSE, warning=FALSE}
# Correlação -------------------------------------------------------------------

cor_spearman <- impulse %>%
                dplyr::select(-id) %>% 
                       mutate(across(-impulsive, 
                                     ~ as.numeric(factor(.,
                                                        levels = c("CL0", "CL1", "CL2", "CL3", "CL4", "CL5", "CL6"),
                                                        labels = 0:6))))


cor_results <- cor_spearman %>%
               summarise(across(-impulsive, ~ cor.test(impulsive, ., method = "spearman")$estimate))

cor_results <- cor_results %>% 
               tidyr::pivot_longer(cols = alcohol:vsa) %>% 
               dplyr::rename("Substâncias" = "name",
                             "Correlação" = "value") 


knitr::kable(cor_results, 
             caption = "Correlação de Spearman")
```

**Conclusão: como pode ser observado, todas as variáveis têm correlação fraca e positiva com a impulsividade, com exceção da variável choc (chocolate). Com destaque para a maconha (cannabis) com maior correlação.**



# **QUESTÃO 06**: Classifique as variáveis entre qualitativas (ordinal ou nominal), ou quantitativas (discreta, contínuas).


**A classificação das variáveis pode ser visualizado na tabela a seguir:** 

```{r}
six <- data.frame(var = c("id", "age", "gender", 
                          "education", "country", 
                          "ethnicity", "income_usd", "nscore", 
                          "escore", "oscore", "a_score", 
                          "cscore", "impulsive", "ss", 
                          "alcohol", 
                          "amphet", "amyl", "benzos", "caff", 
                          "cannabis", "choc", "coke", "crack", "ecstasy", 
                          "heroin", "ketamine", "legalh", "lsd", "meth", 
                          "mushrooms", "nicotine", "semer", "vsa"), 
                  qualitativa = c("sim","sim", "sim", 
                                  "sim", "sim", "sim", "não", "não", 
                                  "não", "não", "não", "não", "não", "não",
                                  "sim", 
                                  "sim", "sim", "sim", "sim", "sim", "sim", "sim", "sim", "sim", "sim", "sim", "sim", 
                                  "sim", "sim", "sim", "sim", "sim", "sim"), 
                  classe = c("nominal", "ordinal", "nominal", "ordinal", 
                             "nominal", "nominal", "contínua", "contínua", 
                             "contínua", "contínua", "contínua", "contínua", "contínua", 
                             "contínua", 
                             "ordinal", 
                             "ordinal", "ordinal", "ordinal", "ordinal", "ordinal", "ordinal", 
                             "ordinal", "ordinal", "ordinal", "ordinal", "ordinal", "ordinal", 
                             "ordinal", "ordinal", "ordinal", "ordinal", "ordinal", "ordinal"))

knitr::kable(six, 
             caption = "Estrutura dos dados")
```


# **QUESTÃO 07**: Qual é a proporção de consumo de substâncias legais versus ilícitas na amostra (considere a definição de legalidade segundo a legislação brasileira)?

```{r}
# Criando um data frame com a classificação das drogas
drogas <- data.frame(
  droga = c("alcohol", "amphet", "amyl", "benzos", "caff", "cannabis", 
            "choc", "coke", "crack", "ecstasy", "heroin", "ketamine", 
            "legalh", "lsd", "meth", "mushrooms", "nicotine", "semer", "vsa"),
  status = c("lícita", "ilícita", "ilícita", "ilícita", "lícita", "ilícita", 
             "lícita", "ilícita", "ilícita", "ilícita", "ilícita", "ilícita", 
             "ilícita", "ilícita", "ilícita", "ilícita", "lícita", "ilícita", "ilícita"))

knitr::kable(drogas)

```


# **QUESTÃO 08**:Quais fatores predizem a probabilidade de um indivíduo consumir crack (Crack)?


Para verificar quais variáveis são mais relevantes para predizer o consumo de crack, pode-se modelar uma regressão via LASSO. Na qual temos a seguinte função de custo com parâmetro $\lambda$ de regularização:   

$$
\min_{\beta_0, \beta} \left\{ \frac{1}{2N} \sum_{i=1}^{N} \left( y_i - \beta_0 - \sum_{j=1}^{p} \beta_j x_{ij} \right)^2 + \lambda \sum_{j=1}^{p} |\beta_j| \right\}
$$

Observe que com $\lambda$ igual a zero temos a minimazação clássica de mínimos quadrados. Porém, à medida que $\lambda$  aumenta, a penalização faz com que os coeficientes sejam encolhidos em direção a zero, ou seja, removendo alguns coeficientes que são exatamente iguais a zero (menos relevantes). 


Assim, no presente caso, pode-se modelar uma regressão na qual a variável dependente é o uso ou não de crack (0 = caso nunca usou, 1 = caso tenha usado alguma vez na vida) contra todas as variáveis do dataset. Por fim, via LASSO, filtra-se as 10 mais relevantes para explicar o uso de crack: 


```{r}

add_crack <- data_clean %>% 
             dplyr::mutate(user_crack = ifelse(crack == "CL0", 0,1)) %>% 
                    select(-id, -age_factor, -crack) %>% 
                    relocate(user_crack, .after = NULL) %>% 
                    mutate(age = factor(age), 
                           gender = factor(gender),
                           education = factor(education), 
                           country = factor(country), 
                           ethnicity = factor(ethnicity), 
                           alcohol = factor(alcohol), 
                           amphet = factor(amphet), 
                           amyl = factor(amyl), 
                           benzos = factor(benzos), 
                           caff = factor(caff), 
                           cannabis = factor(cannabis), 
                           choc = factor(choc), 
                           coke = factor(coke), 
                           ecstasy = factor(ecstasy), 
                           heroin = factor(heroin), 
                           ketamine = factor(ketamine), 
                           legalh = factor(legalh), 
                           lsd = factor(lsd), 
                           meth = factor(meth), 
                           mushrooms = factor(mushrooms), 
                           nicotine = factor(nicotine), 
                           semer = factor(semer), 
                           vsa = factor(vsa))


# Modelo LASSO para seleção de variáveis 

add_crack_matrix <- stats::model.matrix(user_crack ~ ., data = add_crack)[,-1]

cv_lasso <- glmnet::cv.glmnet(add_crack_matrix, 
                              add_crack$user_crack,
                              alpha = 1, family = "binomial")

best_lambda <- cv_lasso$lambda.min

# Ajustar o modelo com o melhor lambda 

lasso_model <- glmnet(add_crack_matrix,
                      add_crack$user_crack, alpha = 1, 
                      family = "binomial", lambda = best_lambda)
```


```{r}

vip::vip(lasso_model, 
    lambda = best_lambda,
    num_features = 10) +
    geom_bar(stat = "identity", 
             fill = "darkorange")+
    ggtitle("Variáveis mais relevantes para explicar o uso de crack")
    
```

**Conclusão: De acordo com o método adotado, o uso de cogumelos mágicos "hoje", heroína no "último mês" e "hoje", respectivamente, são as três variáveis mais relevantes para explicar o uso de crack. O restante das variáveis relevantes são: VSA (classe de consumo de abuso de substâncias voláteis), uso de heroína e cocaína. Drogas que, de fato, costumeiramente estão correlacionadas com o uso de drogas mais pesadas como o crack.**


# **QUESTÃO 09**: Qual é a média das pontuações Nscore, Escore, Oscore, AScore, Cscore? Calcule a correlação entre elas.

A segue pode-se visualizar a média e o teste de Shapiro-Wilk para verificar a normalidade das respectivas variáveis, pois o teste de correlação de Pearson pressupõe distribuição Gaussiana. Nota-se que escore, oscore, a_score não tem distribuição Gaussiana, logo, é necessário tomar os resultados com cautela. 


A correlação pode ser calculada como segue: 

$$
r = \frac{\sum (X_i - \overline{X})(Y_i - \overline{Y})}{\sqrt{\sum (X_i - \overline{X})^2 \sum (Y_i - \overline{Y})^2}}
$$

```{r}
scores = data_clean %>%
         dplyr::select(nscore, 
                       escore, 
                       oscore, 
                       a_score, 
                       cscore) %>% 
         stats::na.omit() 

for (i in 1:4) {
 
  # Executar o teste de Shapiro-Wilk e média aritmética
  print("***********************************")
  cat("Teste de Shapiro-Wilk para a variável: ", base::colnames(scores)[i], "\n")
  cat("Variável com média: ", base::mean(scores[[i]]), "\n")
  sw = stats::shapiro.test(scores[[i]])
  print(sw)
  
  
  if(sw["p.value"] < 0.05){
    cat("\n")
    cat("Variável não tem normalidade")
    cat("\n")
  } else{
    cat("\n")
    cat("Variável com distribuição normal")
    cat("\n")
}
  
  
  
}
```

**Assim, pode-se visualizar a correlação de Pearson:** 

```{r}
GGally::ggpairs(scores, 
                title = "Matriz de correlação")             

```

# **QUESTÃO 10**: Analise a relação entre o nível de educação (Education) e o consumo de diferentes substâncias ilícitas (como LSD, Amphet, Cannabis, etc.). Identifique se há uma correlação significativa entre essas variáveis e, em caso afirmativo, explore a natureza dessa correlação (positiva/negativa).



# **QUESTÃO 11**: Treine uma árvore de decisão para prever se um indivíduo consome uma determinada substância (por exemplo, álcool, anfetaminas, cannabis) com base em suas características demográficas e pontuações de personalidade. Utilize a acurácia para avaliar os seus resultados.


# **QUESTÃO 12**:Explore a correlação entre a idade (variável Age) e a experimentação de diferentes substâncias ilícitas. Verifique se há uma tendência de aumento ou diminuição do consumo conforme a idade avança.


# **QUESTÃO 13**: Quais são as 3 drogas mais utilizadas para cada país presente na amostra? E quais são as 3 menos utilizadas?


